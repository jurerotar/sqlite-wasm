name: Build SQLite WASM

on:
  workflow_dispatch:
    inputs:
      sqlite_ref:
        description: 'SQLite reference (tag, branch, or commit)'
        required: true
        default: 'master'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t sqlite-wasm-builder:env .

      - name: Run build
        run: |
          mkdir -p out
          docker run --rm \
            -e SQLITE_REF="${{ github.event.inputs.sqlite_ref }}" \
            -e BUILD_THREADS=$(nproc) \
            -e HOST_UID="$(id -u)" \
            -e HOST_GID="$(id -g)" \
            -v "$(pwd)/out":/out \
            -v "$(pwd)/src/bin":/src/bin \
            sqlite-wasm-builder:env build

      - name: Check for changes
        id: git-check
        run: |
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update SQLite WASM binaries to ${{ github.event.inputs.sqlite_ref }}"
          title: "Update SQLite WASM binaries to ${{ github.event.inputs.sqlite_ref }}"
          body: |
            This PR updates the SQLite WASM binaries in `src/bin` by building them from SQLite reference `${{ github.event.inputs.sqlite_ref }}`.
            
            Triggered by manual workflow dispatch.
          branch: update-sqlite-wasm
          base: main
          delete-branch: true
